digraph {
  rankdir=TB;
  bgcolor="transparent";
  node [fontname="Helvetica" fontsize=11];
  edge [color="#555555"];

  // Places
  node [shape=circle style=filled fillcolor="#e8f4fd" color="#4a90d9" penwidth=1.5];
  userQuery [label="userQuery\n(1)"];
  planReady [label="planReady"];
  searchDecision [label="search\nDecision"];
  dbDecision [label="db\nDecision"];
  codeDecision [label="code\nDecision"];
  searchPending [label="search\nPending"];
  searchDone [label="search\nDone"];
  dbPending [label="db\nPending"];
  dbDone [label="db\nDone"];
  codePending [label="code\nPending"];
  codeApproved [label="code\nApproved"];
  codeDone [label="code\nDone"];
  resultsReady [label="results\nReady"];
  iterationBudget [label="iteration\nBudget (3)"];

  // Human gate place — highlighted
  node [fillcolor="#fff3cd" color="#d4a017"];
  humanApproval [label="human\nApproval"];

  // Terminal place — highlighted
  node [fillcolor="#d4edda" color="#28a745"];
  responseGenerated [label="response\nGenerated"];

  // Transitions
  node [shape=box style="filled,rounded" fillcolor="#f0f0f0" color="#666666" penwidth=1];
  plan;
  distribute;
  dispatchSearch;
  skipSearch;
  completeSearch;
  dispatchDB;
  skipDB;
  completeDB;
  dispatchCode;
  skipCode;
  requestApproval;
  approveCode;
  rejectCode;
  executeCode;
  joinResults;
  generate;
  iterate;

  // Flow
  userQuery -> plan;
  plan -> planReady;
  planReady -> distribute;

  // Fan-out
  distribute -> searchDecision;
  distribute -> dbDecision;
  distribute -> codeDecision;

  // Search
  searchDecision -> dispatchSearch;
  dispatchSearch -> searchPending;
  searchDecision -> skipSearch;
  skipSearch -> searchDone;
  searchPending -> completeSearch;
  completeSearch -> searchDone;

  // DB
  dbDecision -> dispatchDB;
  dispatchDB -> dbPending;
  dbDecision -> skipDB;
  skipDB -> dbDone;
  dbPending -> completeDB;
  completeDB -> dbDone;

  // Code (with human gate)
  codeDecision -> dispatchCode;
  dispatchCode -> codePending;
  codeDecision -> skipCode;
  skipCode -> codeDone;
  codePending -> requestApproval;
  requestApproval -> humanApproval;
  humanApproval -> approveCode;
  approveCode -> codeApproved;
  humanApproval -> rejectCode;
  rejectCode -> codeDone;
  codeApproved -> executeCode;
  executeCode -> codeDone;

  // Join
  searchDone -> joinResults;
  dbDone -> joinResults;
  codeDone -> joinResults;
  joinResults -> resultsReady;

  // Decision: generate or iterate
  resultsReady -> generate;
  generate -> responseGenerated;
  resultsReady -> iterate;
  iterationBudget -> iterate;
  iterate -> userQuery;
}
